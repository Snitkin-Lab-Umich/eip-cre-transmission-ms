---
title: "EIP CRE transmission network manuscript figures and data"
date: "2/17/2022"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE, message = FALSE, warning = FALSE)
```

```{r}
# load libraries
library(tidyverse)
library(ggtree)
library(pheatmap)
library(igraph)
library(regentrans)
library(tidygraph)
library(ggraph)
library(exact2x2)
library(cowplot)
library(readxl)
library(ape)
library(phytools)
library(ggtree)
library(ggtext)
library(lubridate)
library(scales)
library(ggrepel)

# set plotting theme
theme_set(
  theme_bw() + 
    theme(text = element_text(size = 10), 
          axis.text.x = element_text(angle = 0),
  strip.background = element_rect(fill="white",linetype='blank'))) 

# load transition edge script
source('code/get_transition_edges.R')

# set seed
set.seed(0)
```

```{r}
# load in data
# facility and ST
facil_st_orig <- read_csv('data/isolate_data.csv') %>% 
  mutate(cult_year = gsub('-.*|.*/', '', Cult_Date))
# to make analyses more consistent across states
facil_st <- facil_st_orig %>% 
  filter(cult_year >= 2016)
# public isolate data
metadat_complete <- read_csv('data/public_isolate_metadata.csv') 
# public isolate trees
tree_list <- read_rds('data/tree_list.rds')
# pairwise snv distances
kp_dists <- read_rds('data/kp_dists.rds')
ec_dists <- read_rds('data/eh_dists.rds')
# phylogenetic trees
tr_kp <- read.tree('data/kp_tr.tree')
tr_ec <- read.tree('data/eh_tr.tree')
# clinical factors
pt_feats_ct <- read_csv('data/pt_feats_ct.csv')
pt_feats_mn <- read_csv('data/pt_feats_mn.csv')
pt_feats_tn <- read_csv('data/pt_feats_tn.csv')
# shared facility exposures
pr_hosp_pairs_ct <- read_csv('data/pr_hosp_pairs_ct.csv')
pr_hosp_pairs_mn_orig <- read_csv('data/pr_hosp_pairs_mn.csv')
pr_hosp_pairs_mn <- pr_hosp_pairs_mn_orig
pr_hosp_pairs_tn <- read_csv('data/pr_hosp_pairs_tn.csv')
# patient transfer networks
ct_trans_net_sub <- read_csv('data/trans_net_ct.csv')
mn_trans_net_sub <- read_csv('data/trans_net_mn.csv')
tn_trans_net_sub <- read_csv('data/trans_net_tn.csv')
# facility types
facil_types <- read_csv('data/facil_types.csv')
# facility counts
facil_type_counts <- read_csv('data/facil_type_counts.csv')
# prior tn hospitals
prior_hosps_tn <- read_csv('data/pr_hosps_tn.csv')
# tn facil clutser
tn_facil_cluster <- read_csv('data/tn_facil_cluster.csv')
```

```{r}
# dominant STs and colors
st_cts <- rev(sort(table(facil_st$ST)))
dominant_sts <- names(st_cts)[st_cts > 10 & names(st_cts) != 'Other species']
st_cols <- rep(NA, length(st_cts))
names(st_cols) <- names(st_cts)
st_cols['K. pneumoniae ST258'] <- 'coral4'
st_cols['K. pneumoniae ST307'] <- 'coral3'
st_cols['E. hormaechei ST171'] <- 'aquamarine4'
st_cols['E. hormaechei ST114'] <- 'aquamarine3'
st_cols[is.na(st_cols)] <- 'grey'
st_cols['Other'] <- 'grey'
```

## Data summary

### Number of facilities with CRE per state

```{r}
facil_st %>% 
  group_by(State) %>% 
  summarize(n_facil = n_distinct(Facility_ID))
```

## Facility type information (Table S1)

```{r}
# number of each facility type per state
facil_type_counts
```

```{r}
# facility types with at least one WGS 
facil_types %>% 
  group_by(state, type) %>% 
  summarize(count = n()) %>% 
  pivot_wider(names_from = state, values_from = count, values_fill = 0) 
```

### Isolate counts by state 

```{r}
state_dates <- facil_st %>% mutate(Cult_Date = gsub('-.*|.*/','', Cult_Date)) %>% 
  filter(!is.na(Cult_Date)) %>% 
  group_by(State, Cult_Date) %>% summarize() %>% 
  group_by(State) %>% summarize(min_cult_date = min(Cult_Date),
                                max_cult_date = max(Cult_Date))

facil_st %>% 
  mutate(State = factor(State, levels = c('MN','TN','CT'))) %>% 
  group_by(State) %>% 
  count() %>% full_join(state_dates, .) %>% 
  suppressMessages()
```

### Isolate overview (Figure S1A)

```{r}
fs1a <- facil_st %>% 
  mutate(ST = ifelse(ST %in% c('E. hormaechei ST114','E. hormaechei ST171', 
                                 'K. pneumoniae ST258', 'K. pneumoniae ST307'), ST, 
                       'Other'),
           ST = factor(ST, levels = rev(c('E. hormaechei ST171', 'E. hormaechei ST114', 
                                      'K. pneumoniae ST258', 'K. pneumoniae ST307', 
                                      'Other')))) %>% 
  group_by(State, ST, cult_year) %>% 
  filter(!is.na(cult_year)) %>% 
  summarize(count = n()) %>% 
  ggplot(aes(x = cult_year, y = count, fill = ST)) +
  facet_grid(~State, scales = 'free', space = 'free') +
  geom_col() +
  scale_fill_manual(values = st_cols, 
                    breaks = c('E. hormaechei ST171', 'E. hormaechei ST114',
                               'K. pneumoniae ST258', 'K. pneumoniae ST307',
                               'Other'), 
                    labels = c('KPC-Eh ST171', 'KPC-Eh ST114',
                               'KPC-Kp ST258', 'KPC-Kp ST307',
                               'Other')) +
  theme(legend.text = element_markdown()) +
  labs(x = 'Culture year', y = 'Number of isolates')
```

### Species counts by facility (Figure S1B)

```{r}
fs1b <- facil_st %>% filter(Species != 'Other') %>% 
    mutate(ST = factor(ST, levels = rev(names(st_cols))),
           Species = factor(Species, levels = c('K. pneumoniae','E. hormaechei','Other'),
                            labels = c('KPC-Kp', 'KPC-Eh', 'Other'))) %>% 
  ggplot(aes(x = Facility_ID, fill = ST)) + geom_bar(color = 'white') + 
  facet_grid(Species~State, scales = 'free', space = 'free') +
  scale_fill_manual(values = st_cols, 
                    breaks = c('E. hormaechei ST171', 'E. hormaechei ST114',
                               'K. pneumoniae ST258', 'K. pneumoniae ST307', 
                               'Other'), 
                    labels = c('KPC-Eh ST171', 'KPC-Eh ST114',
                               'KPC-Kp ST258', 'KPC-Kp ST307', 
                               'Other'),
                    drop = FALSE) +
  labs(y = 'Number of isolates', fill = '', x = 'Facility') +
  theme(axis.text.x = element_blank(), axis.ticks.x = element_blank(),
        panel.grid.major = element_blank(), panel.grid.minor = element_blank(),
        legend.text = element_markdown())
```

```{r, fig.width=5, fig.height=5}
fs1 <- plot_grid(fs1a, fs1b + theme(legend.position = 'none'), ncol = 1, labels = 'AUTO')

ggsave(plot = fs1, filename = 'figures/FigS1.png', width = 5, height = 5)

fs1
```

## Public data & trees (Figure S2)

```{r}
public_loc_plot <- metadat_complete %>% 
  mutate(state = ifelse(is.na(state), 'Unknown', state),
         kpc = case_when(is.na(kpc) ~ 'Unknown',
                         kpc == 0 ~ 'No',
                         kpc == 1 ~ 'Yes'),
         kpc = factor(kpc, levels = c('Yes', 'No', 'Unknown'))) %>% 
  group_by(state) %>% 
  mutate(tot = n()) %>%
  ggplot(aes(x = reorder(state, tot), fill = kpc)) +
  geom_bar() +
  labs(x = 'State', y = 'Number of public isolates', fill = 'KPC\npresent') +
  scale_y_log10() +
  scale_fill_manual(values = c('aquamarine3', 'aquamarine4', 'darkgrey')) +
  coord_flip()

public_dates_plot <- metadat_complete %>% 
  ggplot(aes(x = year)) +
  geom_bar() +
  labs(x = 'Year', y = 'Number of public isolates')

fs2ab <- plot_grid(public_dates_plot, public_loc_plot, ncol = 1, rel_heights = c(0.5, 1), align = 'vh', axis = 'trbl', labels = 'AUTO') 
```

```{r}
states <- metadat_complete %>% select(isolate_no, state) %>% deframe()
states <- unique(states[c(tree_list[[1]]$tip.label, tree_list[[4]]$tip.label, tree_list[[7]]$tip.label, tree_list[[12]]$tip.label)])
states <- states[!is.na(states)]
state_cols <- c('#e6194b', '#3cb44b', '#4363d8', '#f58231', '#911eb4', '#46f0f0', '#f032e6', '#bcf60c', '#fabebe', '#008080', '#e6beff', '#9a6324', '#fffac8', '#800000', '#aaffc3', '#808000', '#ffd8b1', '#000075', '#808080', '#ffffff', '#000000', '#ffe119')
names(state_cols) <- states

plot_tr_locs <- function(tr, og, title = NULL){
  tr <- root(tr, og)
  tr <- drop.tip(tr, og)
  states <- metadat_complete %>% select(isolate_no, state) %>% deframe()
  states <- states[tr$tip.label]
  kpc <- metadat_complete %>% select(isolate_no, kpc) %>% deframe()
  kpc <- kpc[tr$tip.label]
  no_info <- is.na(states) & is.na(kpc)
  states <- states[!no_info]
  kpc <- kpc[!no_info]
  kpc <- ifelse(kpc == 1, 'Present', 'Absent')
  tr <- keep.tip(tr, union(names(states), names(kpc)))
  states <- c(states, rep(NA, Nnode(tr)))
  states <- factor(states, levels = sort(names(state_cols[!is.na(names(state_cols))])))
  kpc <- c(kpc, rep(NA, Nnode(tr)))
  ggtree(tr) + 
    geom_tippoint(aes(col = states, shape = kpc)) + 
    scale_color_manual(values = state_cols, drop=FALSE) + 
    scale_shape_manual(values = c('Present' = 16, 'Absent' = 1)) +
    guides(color = guide_legend(ncol = 3)) +
    labs(title = title, shape = 'KPC', col = 'State')
}



tr_st114 <- plot_tr_locs(tree_list[[7]], 'MN_CRE226', '*E. hormaechei* ST114') + 
  theme(legend.position = 'none', plot.title = ggtext::element_markdown())
tr_st171 <- plot_tr_locs(tree_list[[4]], 'MN_CRE226', '*E. hormaechei* ST171') + 
  theme(legend.position = 'none', plot.title = ggtext::element_markdown())
tr_st258 <- plot_tr_locs(tree_list[[1]], '573.1451', '*K. pneumoniae* ST258') + 
  theme(legend.position = 'none', plot.title = ggtext::element_markdown())
tr_st307 <- plot_tr_locs(tree_list[[12]], '573.13662', '*K. pneumoniae* ST307') + 
  theme(legend.position = 'none', plot.title = ggtext::element_markdown())
leg <- get_legend(plot_tr_locs(tree_list[[1]], '573.1451', '*K. pneumoniae* ST258'))

fs2c <- plot_grid(plot_grid(tr_st171, tr_st114, tr_st258, tr_st307), 
                  leg, ncol = 1, rel_heights = c(1, 0.6))
```


```{r, fig.width=10, fig.height=8}
fs2 <- plot_grid(fs2ab, fs2c, labels = c('', 'C'), label_x = -0.1)
ggsave('figures/FigS2.png', width = 10, height = 8)
fs2
```


## Evidence of importation

```{r}
kpc_bin <- metadat_complete %>% select(isolate_no, kpc) %>% drop_na() 
mn_bin <- metadat_complete %>% select(isolate_no, mn_bin) %>% drop_na()
tn_bin <- metadat_complete %>% select(isolate_no, tn_bin) %>% drop_na()
ct_bin <- metadat_complete %>% select(isolate_no, ct_bin) %>% drop_na()

genomes <- unique(c(kpc_bin$isolate_no, mn_bin$isolate_no, tn_bin$isolate_no, ct_bin$isolate_no))

keepers <- facil_st %>% 
  filter(!(duplicated(Patient_ID) & duplicated(ST))) %>% 
  pull(Sample_ID)

transitions <- lapply(1:length(tree_list), function(x){
  
  st <- names(tree_list)[[x]]
  
  t <- midpoint.root(tree_list[[x]])
  t <- keep.tip(t, t$tip.label[t$tip.label %in% genomes])
  
  kpc_trans_edges = mn_trans_edges = tn_trans_edges = ct_trans_edges = NULL
  
  kpc_bin_sub <- kpc_bin %>% filter(isolate_no %in% t$tip.label)
  if(length(unique(kpc_bin_sub$kpc)) != 1){
    kpc_trans_edges <- transition_edge_pipeline(kpc_bin_sub, t, continuous = FALSE, ar_conf = 0.5)
  }
  mn_bin_sub <- mn_bin %>% filter(isolate_no %in% t$tip.label)
  if(length(unique(mn_bin_sub$mn_bin)) != 1){
    mn_trans_edges <- transition_edge_pipeline(mn_bin_sub, t, continuous = FALSE, ar_conf = 0.5)
  }
  tn_bin_sub <- tn_bin %>% filter(isolate_no %in% t$tip.label)
  if(length(unique(tn_bin_sub$tn_bin)) != 1){
    tn_trans_edges <- transition_edge_pipeline(tn_bin_sub, t, continuous = FALSE, ar_conf = 0.5)
  }
  ct_bin_sub <- ct_bin %>% filter(isolate_no %in% t$tip.label)
  if(length(unique(ct_bin_sub$ct_bin)) != 1){
    ct_trans_edges <- transition_edge_pipeline(ct_bin_sub, t, continuous = FALSE, ar_conf = 0.5)
  }
  
  if(is.null(kpc_trans_edges) & is.null(mn_trans_edges) & is.null(tn_trans_edges) & is.null(ct_trans_edges)) return(NULL)
  
  trans_sum <- paste0(
    ifelse(mn_trans_edges$mn_bin$trans_dir != 1, '', 'to_mn '), 
    ifelse(tn_trans_edges$tn_bin$trans_dir != 1, '', 'to_tn '), 
    ifelse(ct_trans_edges$ct_bin$trans_dir != 1, '', 'to_ct '), 
    ifelse(kpc_trans_edges$kpc$trans_dir != 1, '', 'gain_kpc ')
  )
  
  edge <- data.frame(t$edge, 
                  edge_num=1:nrow(t$edge), 
                  edge_val = trans_sum[1:(length(trans_sum)-1)]) %>% 
    mutate(edge_val = ifelse(edge_val == '', NA, edge_val))
  colnames(edge)=c("parent", "node", "edge_num","edge_val")
  
  trans_edge_nums <- sapply(unique(metadat_complete$isolate_no[grepl('^EIP',metadat_complete$sources) &
                                                                  metadat_complete$isolate_no %in% t$tip.label]),
                            function(i){
    trans <- NA
    child <- which(t$tip.label == i)
    edge_num <- NA
    while(is.na(trans) & child != (Ntip(t) + 1)){ # if find transition going backwards or get to root
      child_edge_info <- edge %>% filter(node == child)
      trans <- child_edge_info %>% select(edge_val) %>% deframe()
      child <- child_edge_info %>% select(parent) %>% deframe()
      if(!is.na(trans)){
        edge_num <- child_edge_info %>% select(edge_num) %>% deframe()
      }
    }
    edge_num
  })
  
  trans_edge_nums <- trans_edge_nums[!is.na(trans_edge_nums)] #recently added
  
  grps <- data.frame(id=names(trans_edge_nums),
                     class=trans_sum[trans_edge_nums],
                     cluster=trans_edge_nums) %>% 
    mutate(state = factor(gsub('_.*','',id), levels = c('MN','TN','CT')),
           ST = sapply(id, function(x){
             val <- unlist(unique(metadat_complete$ST[metadat_complete$isolate_no == x & !is.na(metadat_complete$ST)]))
             val <- ifelse(length(val) == 0, paste0('ST', unlist(unique(metadat_complete$mlst[metadat_complete$isolate_no == x & !is.na(metadat_complete$mlst)]))), val)
             val <- ifelse(length(val) == 0 | val == 'ST', st, val)
             ifelse(length(val) == 0, NA, val)
           }),
           species = sapply(id, function(x){
             val <- unlist(unique(metadat_complete$species[metadat_complete$isolate_no == x & !is.na(metadat_complete$species)]))
             ifelse(length(val) == 0, NA, val)
           }),
           ST_orig = ST,
           ST = ifelse(ST %in% c('E. hormaechei ST171','E. hormaechei ST114',
                                 'K. pneumoniae ST258','K. pneumoniae ST307', 
                                 'E. cloacae ST171', 'E. cloacae ST114', 
                                 'ST258', 'ST307', 'ST114', 'ST171'),
                       ST, 'Other'),
           tree = st
           )
  if(nrow(grps) == 0) return(NULL)
  grps
}) %>% 
  bind_rows() %>% suppressWarnings() %>% 
  mutate(class = gsub('NA| ', '', class), 
         class = ifelse(is.na(class), '', class),
         class2 = ifelse(grepl('gain_kpc', class), 'No', class),
         class2 = ifelse(class2 == '', 'No', class2),
         class2 = ifelse(grepl('to_', class2), 'Yes', class2),
         class2 = factor(class2, levels = c('Yes','No')),
         ST = ifelse(ST %in% c('ST258','ST307'), paste0('K. pneumoniae ', ST), ST),
         ST = ifelse(ST %in% c('ST171','ST114'), paste0('E. hormaechei ', ST), ST),
         ST = gsub('cloacae', 'hormaechei', ST),
         ST_orig = gsub('cloacae', 'hormaechei', ST_orig),
         ST = factor(ST, levels = (c("E. hormaechei ST171", "E. hormaechei ST114", 
                                     "K. pneumoniae ST258", "K. pneumoniae ST307", 
                                     'Other'))),
         state = factor(state, levels = c('CT', 'MN', 'TN'))) %>% 
  filter(id %in% keepers) %>% 
  arrange(ST)
```



### Evidence of importation (Figure 1)

```{r}
transitions <- transitions %>% 
  mutate(ST = ifelse(grepl('ST258', ST_orig), 'K. pneumoniae ST258', as.character(ST))) 
clust_cols <- st_cols[as.character(transitions$ST)]
names(clust_cols) <- paste0(transitions$state, transitions$ST, transitions$cluster)

clust_cols <- (c(clust_cols[clust_cols == "grey"][sort(names(clust_cols[clust_cols == "grey"]), decreasing = TRUE)],
                clust_cols[clust_cols == "coral3"][sort(names(clust_cols[clust_cols == "coral3"]), decreasing = TRUE)],
                clust_cols[clust_cols == "coral4"][sort(names(clust_cols[clust_cols == "coral4"]), decreasing = TRUE)],
                clust_cols[clust_cols == "aquamarine3"][sort(names(clust_cols[clust_cols == "aquamarine3"]), decreasing = TRUE)],
                clust_cols[clust_cols == "aquamarine4"][sort(names(clust_cols[clust_cols == "aquamarine4"]), decreasing = TRUE)]
                ))
```

```{r, fig.width=7, fig.height=4}
f1 <- transitions %>% 
  ggplot(aes(x = class2, 
             fill = factor(paste0(state, ST, cluster), 
                           levels = unique(paste0(state, ST, cluster))))) + 
  geom_bar(color = 'white', position = position_stack(reverse = TRUE)) + 
  scale_fill_manual(values = clust_cols,
                    breaks = rev(names(clust_cols)[!duplicated(clust_cols)]),
                    labels = c('KPC-Eh ST171', 'KPC-Eh ST114',
                               'KPC-Kp ST258', 'KPC-Kp ST307',
                               'Other'),
                    drop = FALSE) +
  facet_grid(~state, scales = 'free', space = 'free') +
  labs(fill = 'ST cluster', x = 'Evidence that KPC-harboring strain was imported', y = 'Number of isolates') +
  theme(legend.text = ggtext::element_markdown()) 

ggsave(plot = f1, filename = 'figures/Fig1.png', width = 7, height = 4)

f1
```

```{r}
transitions %>% 
  group_by(ST, class2) %>% 
  summarize(count = n()) %>% 
  group_by(ST) %>% 
  mutate(tot = sum(count),
         prop = count/tot)
```

```{r}
# earliest date for ST114 and ST307 
facil_st %>% 
  filter(ST %in% c('E. hormaechei ST114', 'K. pneumoniae ST307') & State == 'TN') %>% 
  group_by(State, ST) %>% 
  mutate(Cult_Date = mdy(Cult_Date)) %>% 
  slice_min(Cult_Date) %>% 
  select(State, ST, Cult_Date)
```


## Distances

```{r}
# snv distances
kp_snv_dists <- get_pair_types(kp_dists, facil_st %>% select(Sample_ID, Facility_ID) %>% deframe(), pt = NULL) %>% 
  filter(!sapply(1:nrow(.), function(x) sort(c(as.character(isolate1[x]),as.character(isolate2[x])))) %>% t() %>% duplicated()) %>% 
  mutate(st1 = sapply(isolate1, function(x) facil_st$ST[facil_st$Sample_ID == x]),
         st2 = sapply(isolate2, function(x) facil_st$ST[facil_st$Sample_ID == x]),
         state1 = sapply(isolate1, function(x) facil_st$State[facil_st$Sample_ID == x]),
         state2 = sapply(isolate2, function(x) facil_st$State[facil_st$Sample_ID == x])) %>% 
  filter(st1 == st2 & !grepl('novel',st1)) %>% 
  mutate(state_pair = paste(state1, state2)) 

ec_snv_dists <- get_pair_types(ec_dists, facil_st %>% select(Sample_ID, Facility_ID) %>% deframe(), pt = NULL) %>% 
  filter(!sapply(1:nrow(.), function(x) sort(c(as.character(isolate1[x]),as.character(isolate2[x])))) %>% t() %>% duplicated()) %>% 
  mutate(st1 = sapply(isolate1, function(x) facil_st$ST[facil_st$Sample_ID == x]),
         st2 = sapply(isolate2, function(x) facil_st$ST[facil_st$Sample_ID == x]),
         state1 = sapply(isolate1, function(x) facil_st$State[facil_st$Sample_ID == x]),
         state2 = sapply(isolate2, function(x) facil_st$State[facil_st$Sample_ID == x])) %>% 
  filter(st1 == st2 & !grepl('novel',st1)) %>% 
  mutate(state_pair = paste(state1, state2)) 

snv_dat <- bind_rows(kp_snv_dists, ec_snv_dists) %>% filter(state1 == state2) %>% 
  mutate(state1 = factor(state1, levels = c('MN','TN','CT')),
         pair_type = ifelse(is.na(pair_type), 'Unknown', pair_type),
         under_thresh = ifelse(pairwise_dist <= 15, '(10,15]','(15,∞)'),
         under_thresh = ifelse(pairwise_dist <= 10, '(5,10]',under_thresh),
         under_thresh = ifelse(pairwise_dist <= 5, '[0,5]',under_thresh),
         under_thresh = factor(under_thresh, levels = c('[0,5]','(5,10]','(10,15]','(15,∞)')),
         ST_orig = st1,
         ST = ifelse(st1 %in% dominant_sts, st1, 'Other'),
         Species = gsub(' ST.*','',st1),
         ST = gsub('.* ','',ST)) %>% 
  left_join(facil_st %>% select(Sample_ID, cult_year) %>% 
              rename(isolate1 = Sample_ID, year1 = cult_year)) %>% 
  left_join(facil_st %>% select(Sample_ID, cult_year) %>% 
              rename(isolate2 = Sample_ID, year2 = cult_year))
```

```{r}
# patristic distances
kp_pat <- cophenetic.phylo(tr_kp)
ec_pat <- cophenetic.phylo(tr_ec)

kp_pat_dists <- get_pair_types(kp_pat, facil_st %>% select(Sample_ID, Facility_ID) %>% deframe(), pt = NULL) %>% 
  filter(!sapply(1:nrow(.), function(x) sort(c(as.character(isolate1[x]),as.character(isolate2[x])))) %>% t() %>% duplicated()) %>% 
  mutate(st1 = sapply(isolate1, function(x) facil_st$ST[facil_st$Sample_ID == x]),
         st2 = sapply(isolate2, function(x) facil_st$ST[facil_st$Sample_ID == x]),
         state1 = sapply(isolate1, function(x) facil_st$State[facil_st$Sample_ID == x]),
         state2 = sapply(isolate2, function(x) facil_st$State[facil_st$Sample_ID == x])) %>% 
  filter(st1 == st2 & !grepl('novel',st1)) %>% 
  mutate(state_pair = paste(state1, state2)) 

ec_pat_dists <- get_pair_types(ec_pat, facil_st %>% select(Sample_ID, Facility_ID) %>% deframe(), pt = NULL) %>% 
  filter(!sapply(1:nrow(.), function(x) sort(c(as.character(isolate1[x]),as.character(isolate2[x])))) %>% t() %>% duplicated()) %>% 
  mutate(st1 = sapply(isolate1, function(x) facil_st$ST[facil_st$Sample_ID == x]),
         st2 = sapply(isolate2, function(x) facil_st$ST[facil_st$Sample_ID == x]),
         state1 = sapply(isolate1, function(x) facil_st$State[facil_st$Sample_ID == x]),
         state2 = sapply(isolate2, function(x) facil_st$State[facil_st$Sample_ID == x])) %>% 
  filter(st1 == st2 & !grepl('novel',st1)) %>% 
  mutate(state_pair = paste(state1, state2)) 

pat_dat <- bind_rows(kp_pat_dists, ec_pat_dists) %>% filter(state1 == state2) %>% 
  mutate(state1 = factor(state1, levels = c('MN','TN','CT')),
         pair_type = ifelse(is.na(pair_type), 'Unknown', pair_type),
         ST_orig = st1,
         ST = ifelse(st1 %in% dominant_sts, st1, 'Other'),
         Species = gsub(' ST.*','',st1),
         ST = gsub('.* ','',ST))
```

## Intra- and inter-facility pairwise SNV distances

### Fraction of intra-facility isolates over time (Figure S3A)

```{r}
snvdat_orig <- snv_dat[,1:6] %>% mutate(pairwise_dist = as.numeric(pairwise_dist))

frac_intras <- lapply(unique(c(snv_dat$st1, snv_dat$st2)), function(st){
  lapply(c('MN MN','TN TN','CT CT'), function(s){
      snvdat_orig_sub <- snvdat_orig[snv_dat$st1 == st & snv_dat$st2 == st & snv_dat$state_pair == s,]
      frac_intra <- NULL
      if(nrow(snvdat_orig_sub) != 0){
        frac_intra <- get_frac_intra(snvdat_orig_sub) %>% mutate(ST = st, state = gsub(' .*','', s))
      }
      frac_intra
  }) %>% bind_rows()
}) %>% bind_rows()


fs3a <- frac_intras %>% 
    mutate(ST = ifelse(ST %in% c('E. hormaechei ST114','E. hormaechei ST171', 
                                 'K. pneumoniae ST258', 'K. pneumoniae ST307'), ST, 
                       'Other'),
           ST = factor(ST, levels = c('E. hormaechei ST171', 'E. hormaechei ST114', 
                                      'K. pneumoniae ST258', 'K. pneumoniae ST307', 
                                      'Other'),
                       labels = c('KPC-Eh<br>ST171', 'KPC-Eh<br>ST114', 
                                      'KPC-Kp<br>ST258', 'KPC-Kp<br>ST307', 
                                      'Other'))) %>% 
  filter(frac_intra != 0 & ST != 'Other') %>% 
  filter(pairwise_dist <= 50) %>%
  ggplot(aes(x = pairwise_dist, y = frac_intra, fill = state)) + 
  geom_bar(stat = "identity") + # fill = "blue", 
  geom_vline(xintercept = c(5, 10, 15), alpha = 0.2) +
  labs(x = "Pairwise SNV distance", y = "Fraction of intra-facility pairs", fill = 'State') + 
  facet_grid(ST~., scales = 'free') +
  scale_fill_brewer(palette = 'Set1') +
  scale_x_continuous(breaks = seq(0, 50, by = 5)) +
  theme(strip.text.y = element_markdown(angle = 0), panel.grid = element_blank())
```

### Pairwise SNV distances by pair type, state, and other STs (Figure S3B)

```{r}
fs3b <- snv_dat %>% 
  filter(state1 == state2 & pair_type != 'Unknown' & !is.na(pair_type)) %>%
  mutate(pairwise_dist = ifelse(pairwise_dist == 0, 0.1, pairwise_dist),
         pair_type = factor(gsub(' pair', '', pair_type), levels = c('Intra-facility','Inter-facility')),
         state1 = factor(state1, levels = c('CT','MN','TN')),
         # pair_type = ifelse(is.na(pair_type), 'Unknown', pair_type),
         # pair_type = gsub(' pair', '', pair_type),
         st1 = gsub('K. pneumoniae', 'KPC-Kp', st1),
         st1 = gsub('E. hormaechei', 'KPC-Eh', st1)) %>% 
  ggplot(aes(x = pairwise_dist, y = st1, color = under_thresh)) + 
  # geom_vline(xintercept = c(5, 10, 15), color = 'darkgrey', linetype = 'dashed') +
  geom_jitter(alpha=0.5) + 
  facet_grid(pair_type~state1, scales = 'free', space = 'free') +
  scale_color_manual(values = c('[0,5]' = "#9EBCDA",'(5,10]' = "#BFD3E6", '(10,15]' = "#E0ECF4",'(15,∞)' = "#FBB4AE")) +
  scale_x_continuous(breaks = seq(0, 600, by = 50)) +
  # scale_color_manual(values = c('lightslateblue','black')) +
  labs(y = '', x = 'Pairwise SNV distance', color = 'SNV bin') 
```

### Patristic distance sensitivity analysis (Figure S3C)

```{r}
fs3c <- left_join(snv_dat %>% rename(pd_snv = pairwise_dist), pat_dat %>% rename(pd_pat = pairwise_dist)) %>% 
  filter(state1 == state2 & pair_type != 'Unknown' & !is.na(pair_type)) %>%
  mutate(pair_type = factor(gsub(' pair', '', pair_type), levels = c('Intra-facility','Inter-facility')),
         state1 = factor(state1, levels = c('CT','MN','TN')),
         st1 = gsub('K. pneumoniae', 'KPC-Kp', st1),
         st1 = gsub('E. hormaechei', 'KPC-Eh', st1)) %>% 
  ggplot(aes(x = pd_pat, y = st1, color = under_thresh)) + 
  geom_jitter(alpha=0.5) + 
  facet_grid(pair_type~state1, scales = 'free', space = 'free') +
  scale_color_manual(values = c('[0,5]' = "#9EBCDA",'(5,10]' = "#BFD3E6", '(10,15]' = "#E0ECF4",'(15,∞)' = "#FBB4AE")) +
  scale_x_continuous(breaks = seq(0, 0.01, by = 0.00003)) +
  labs(y = '', x = 'Pairwise patristic distance', color = 'SNV bin') 
```


```{r, fig.width=7.5, fig.height=10.5}
fs3 <- plot_grid(plotlist = list(fs3a, fs3b, fs3c), ncol = 1, labels = 'AUTO',
                 rel_heights = c(0.75, 1.1, 1.1),
                 align = 'hv', axis = 'trbl')

ggsave(plot = fs3, filename = 'figures/FigS3.png', width = 7.5, height = 10.5)

fs3
```

## Intra-facility analysis (Figure 2A)

```{r}
min_dat <- lapply(unique(c(as.character(snv_dat$isolate1), as.character(snv_dat$isolate2))), function(i){
  snv_dat %>% filter((isolate1 == i | isolate2 == i) & pair_type != 'Unknown') %>%
    group_by(pair_type, ST_orig, state1) %>% 
    summarize(dist_min = min(pairwise_dist)) %>% 
    pivot_wider(names_from = pair_type, values_from = dist_min)
}) %>% bind_rows() %>% suppressMessages() %>% suppressWarnings()
```


```{r}
min_dat %>% 
  filter(!is.na(`Inter-facility pair`) & !is.na(`Intra-facility pair`)) %>% 
  group_by(ST_orig, state1) %>% 
  summarize(n = n(), 
            median_intra = median(`Intra-facility pair`),
            median_inter = median(`Inter-facility pair`),
            wilcox_p = wilcox.test(`Intra-facility pair`, `Inter-facility pair`, 
                                   paired = TRUE)$p.value) %>% 
  arrange(-n)
```

```{r}
f2a <- min_dat %>% 
  filter(!is.na(`Inter-facility pair`) & !is.na(`Intra-facility pair`)) %>% 
  group_by(ST_orig, state1) %>% 
  filter(!`Intra-facility pair` > 400) %>% 
  mutate(ST = ifelse(ST_orig %in% c('E. hormaechei ST171', 'E. hormaechei ST114', 
                                        'K. pneumoniae ST258', 'K. pneumoniae ST307'),
                     ST_orig, 'Other')) %>% 
  ggplot(aes(x = `Intra-facility pair`, y = `Inter-facility pair`)) +
  facet_grid(~state1, scales = 'free') +
  geom_abline(intercept = 0, linetype = 'dotted') +
  geom_point(aes( color = ST), alpha = 0.5) +
  geom_text(aes(label = 'y=x', x = 65, y = 80), check_overlap = TRUE) +
  scale_color_manual(values = st_cols, 
                    breaks = c('E. hormaechei ST171', 'E. hormaechei ST114',
                               'K. pneumoniae ST258', 'K. pneumoniae ST307',
                               'Other'), 
                    labels = c('KPC-Eh ST171', 'KPC-Eh ST114',
                               'KPC-Kp ST258', 'KPC-Kp ST307',
                               'Other')) +
  scale_x_continuous(breaks = seq(0, 160, by = 20)) +
  theme(panel.grid = element_blank()) +
  labs(x = 'Minimum pairwise SNV distance of\nan isolate from the same facility', y = 'Minimum pairwise SNV distance of\nan isolate from a different facility')
```


## Clinical factor analysis

```{r}
intra_pairs_ct <- snv_dat %>% filter(loc1 == loc2 & st1 == st2 & state1 == 'CT')
intra_pairs_mn <- snv_dat %>% filter(loc1 == loc2 & st1 == st2 & state1 == 'MN')
intra_pairs_tn <- snv_dat %>% filter(loc1 == loc2 & st1 == st2 & state1 == 'TN')

pt_info_ct <- suppressMessages(lapply(1:nrow(intra_pairs_ct), function(x){
  sub <- pt_feats_ct %>% filter(Sample_ID %in% unlist(c(intra_pairs_ct[x,c('isolate1','isolate2')]))) %>% 
  select_if(colSums(is.na(.)) == 0)
  info <- bind_cols(intra_pairs_ct[x,])%>% mutate(shared_clin = FALSE)
  if(ncol(sub) > 2 & nrow(sub) > 1){
    info <- info %>% mutate(shared_clin = TRUE)
  }
  info
})) %>% bind_rows() 

pt_info_mn <- suppressMessages(lapply(1:nrow(intra_pairs_mn), function(x){
  sub <- pt_feats_mn %>% filter(Sample_ID %in% unlist(c(intra_pairs_mn[x,c('isolate1','isolate2')]))) %>% 
  select_if(colSums(is.na(.)) == 0)
  info <- bind_cols(intra_pairs_mn[x,])%>% mutate(shared_clin = FALSE)
  if(ncol(sub) > 2 & nrow(sub) > 1){
    info <- info %>% mutate(shared_clin = TRUE, shared_comorb = paste0(names(sub)[!names(sub) == 'Sample_ID'], collapse = ','))
  }
  info
})) %>% bind_rows() 

pt_info_tn <- suppressMessages(lapply(1:nrow(intra_pairs_tn), function(x){
  sub <- pt_feats_tn %>% filter(Sample_ID %in% unlist(c(intra_pairs_tn[x,c('isolate1','isolate2')]))) %>% 
    unique() %>% 
    select_if(c(TRUE, colSums(.[,2:ncol(.)]) != 0))
  info <- bind_cols(intra_pairs_tn[x,]) %>% mutate(shared_clin = FALSE)
  if(ncol(sub) > 2 & nrow(sub) > 1){
    info <- info %>% mutate(shared_clin = TRUE, shared_comorb = paste0(names(sub)[!names(sub) == 'Sample_ID'], collapse = ','))
  }
  info
})) %>% bind_rows() 
```


```{r}
shared_clin_pvals <- bind_rows(pt_info_mn, pt_info_tn, pt_info_ct) %>%
  left_join(snv_dat %>% filter(loc1 != loc2)) %>% 
  group_by(state1, st1) %>% 
  filter(sum(shared_clin) != 0 & sum(!shared_clin) != 0) %>%
  summarize(wilcox_p = paste0('p = ', signif(wilcox.test(pairwise_dist[shared_clin], pairwise_dist[!shared_clin], alternative = 'less')$p.value, 5)))
shared_clin_pvals
```


## Inter-facility analysis

### Prior hospital 

#### Individual healthcare exposures 

```{r}
pr_hosp_pairs_ct <- inner_join(pr_hosp_pairs_ct, snv_dat)
pr_hosp_pairs_mn <- inner_join(pr_hosp_pairs_mn_orig, snv_dat) 
pr_hosp_pairs_tn <- inner_join(pr_hosp_pairs_tn, snv_dat)
# pr_hosp_pairs_mn_all <- inner_join(pr_hosp_pairs_mn_orig, mn_snv_dat_orig)

pr_hops_pvals <- bind_rows(pr_hosp_pairs_ct, pr_hosp_pairs_mn, pr_hosp_pairs_tn,
                           # pr_hosp_pairs_mn_all %>% mutate(state1 = 'MN_all')
                           ) %>%
  left_join(snv_dat %>% filter(loc1 != loc2)) %>% 
  group_by(state1, st1) %>% 
  filter(sum(same_pr_hosp) != 0 & sum(!same_pr_hosp) != 0) %>% 
  summarize(n_shared = sum(same_pr_hosp),
            n_not_shared = sum(!same_pr_hosp),
            median_shared = median(pairwise_dist[same_pr_hosp]),
            median_not_shared = median(pairwise_dist[!same_pr_hosp]),
            wilcox_p = paste0('p = ', signif(wilcox.test(pairwise_dist[same_pr_hosp],
                                                         pairwise_dist[!same_pr_hosp], 
                                                         alternative = 'less')$p.value, 1)))
```


```{r}
f2b <- bind_rows(pr_hosp_pairs_ct, pr_hosp_pairs_mn %>% filter(!is.na(state1)), pr_hosp_pairs_tn) %>%
  left_join(snv_dat %>% filter(loc1 != loc2)) %>% 
  mutate(st1 = ifelse(st1 %in% c("E. hormaechei ST114", "E. hormaechei ST171", "K. pneumoniae ST258", "K. pneumoniae ST307"), st1, 'Other')) %>% 
  left_join(pr_hops_pvals) %>% 
  filter(state1 == 'MN' & st1 == 'E. hormaechei ST171' |
           state1 == 'TN' & st1 %in% c('K. pneumoniae ST258', 'K. pneumoniae ST307', 'E. hormaechei ST114')) %>% 
  mutate(same_pr_hosp = factor(ifelse(same_pr_hosp, 'Yes', 'No'), levels = c('Yes', 'No')),
         # st1 = gsub('E', '\\*E', st1),
         # st1 = gsub('K', '\\*K', st1),
         # st1 = gsub('i ', 'i\\* ', st1),
         # st1 = gsub('e ', 'e\\* ', st1),
         wilcox_p = ifelse(wilcox_p == 'p = 9e-07', 'p < 0.001', wilcox_p),
         st1 = gsub('K. pneumoniae', 'KPC-Kp', st1),
         st1 = gsub('E. hormaechei', 'KPC-Eh', st1),
         st1 = paste0(st1, ': ', wilcox_p)) %>% 
  ggplot() +
  facet_grid(~state1+st1, scales = 'free') +
  # geom_text(aes(x = 0, y = 50, label = wilcox_p), check_overlap = TRUE, vjust = 0, hjust = 0) +
  # geom_histogram(aes(x = pairwise_dist), fill = 'white') +
  # geom_histogram(aes(x = pairwise_dist, fill = same_pr_hosp), alpha = 0.5) +
  geom_density(aes(x = pairwise_dist, fill = same_pr_hosp), alpha = 0.5) +
  scale_fill_grey(start = 0.3, end = 0.7) +
  labs(x = 'Pairwise SNV distance', y = 'Density of pairs', fill = 'Shared facility\nexposure') +
  theme(strip.text.x = element_markdown())
```

```{r}
bind_rows(pr_hosp_pairs_ct, pr_hosp_pairs_mn %>% filter(!is.na(state1)), pr_hosp_pairs_tn) %>%
  left_join(snv_dat %>% filter(loc1 != loc2)) %>% 
  mutate(st1 = ifelse(st1 %in% c("E. hormaechei ST114", "E. hormaechei ST171", "K. pneumoniae ST258", "K. pneumoniae ST307"), st1, 'Other')) %>% 
  left_join(pr_hops_pvals) %>% 
  filter(state1 == 'MN' & st1 == 'E. hormaechei ST171' |
           state1 == 'TN' & st1 %in% c('K. pneumoniae ST258', 'K. pneumoniae ST307', 'E. hormaechei ST114')) %>% 
  select(state1, ST, n_shared, n_not_shared) %>% 
  unique()
```




```{r, fig.width=7, fig.height=7}
f2 <- plot_grid(f2a + theme(legend.position = 'top'), 
                          f2b + theme(legend.position = 'bottom'), 
                          ncol = 1, labels = 'AUTO', align = 'h', axis = 'tr')

ggsave(plot = f2, filename = 'figures/Fig2.png', width = 7, height = 7)

f2
```


### MN over time (Figure S4)


```{r}
fs4a <- facil_st_orig %>% 
  filter(State == 'MN' & ST %in% c('K. pneumoniae ST258', 'E. hormaechei ST171')) %>% 
  mutate(facil = ifelse(Facility_ID == 'F38', 'F38', 'Other'),
         facil = ifelse(is.na(facil), 'Other', facil),
         ST = gsub('K. pneumoniae', 'KPC-Kp', ST),
         ST = gsub('E. hormaechei', 'KPC-Eh', ST)) %>% 
  ggplot(aes(x = cult_year, fill = facil)) +
  facet_wrap(~ST) +
  geom_bar() +
  scale_fill_manual(values = rev(c('grey80', 'mistyrose3'))) + #'mistyrose1', 'grey80')) +
  labs(x = 'Year', y = 'Number of isolates', fill = 'Facility')
```

```{r}
# snv distances
mn_kp_snv_dists <- get_pair_types(kp_dists, 
                                  facil_st_orig %>% 
                                    filter(State == 'MN') %>% 
                                    select(Sample_ID, Facility_ID) %>% deframe(), 
                                  pt = NULL) %>% 
  filter(!sapply(1:nrow(.), function(x) sort(c(as.character(isolate1[x]),as.character(isolate2[x])))) %>% t() %>% duplicated()) %>% 
  mutate(st1 = sapply(isolate1, function(x) facil_st_orig$ST[facil_st_orig$Sample_ID == x]),
         st2 = sapply(isolate2, function(x) facil_st_orig$ST[facil_st_orig$Sample_ID == x]),
         state1 = sapply(isolate1, function(x) facil_st_orig$State[facil_st_orig$Sample_ID == x]),
         state2 = sapply(isolate2, function(x) facil_st_orig$State[facil_st_orig$Sample_ID == x])) %>% 
  filter(st1 == st2 & !grepl('novel',st1)) %>% 
  mutate(state_pair = paste(state1, state2)) 

mn_ec_snv_dists <- get_pair_types(ec_dists, facil_st_orig %>% 
                                    filter(State == 'MN') %>% 
                                    select(Sample_ID, Facility_ID) %>% 
                                    deframe(), 
                                  pt = NULL) %>% 
  filter(!sapply(1:nrow(.), function(x) sort(c(as.character(isolate1[x]),as.character(isolate2[x])))) %>% t() %>% duplicated()) %>% 
  mutate(st1 = sapply(isolate1, function(x) facil_st_orig$ST[facil_st_orig$Sample_ID == x]),
         st2 = sapply(isolate2, function(x) facil_st_orig$ST[facil_st_orig$Sample_ID == x]),
         state1 = sapply(isolate1, function(x) facil_st_orig$State[facil_st_orig$Sample_ID == x]),
         state2 = sapply(isolate2, function(x) facil_st_orig$State[facil_st_orig$Sample_ID == x])) %>% 
  filter(st1 == st2 & !grepl('novel',st1)) %>% 
  mutate(state_pair = paste(state1, state2)) 

mn_snv_dat_orig <- bind_rows(mn_kp_snv_dists, mn_ec_snv_dists) %>% filter(state1 == state2) %>% 
  mutate(state1 = factor(state1, levels = c('MN','TN','CT')),
         pair_type = ifelse(is.na(pair_type), 'Unknown', pair_type),
         under_thresh = ifelse(pairwise_dist <= 15, '(10,15]','(15,∞)'),
         under_thresh = ifelse(pairwise_dist <= 10, '(5,10]',under_thresh),
         under_thresh = ifelse(pairwise_dist <= 5, '[0,5]',under_thresh),
         under_thresh = factor(under_thresh, levels = c('[0,5]','(5,10]','(10,15]','(15,∞)')),
         ST_orig = st1,
         ST = ifelse(st1 %in% dominant_sts, st1, 'Other'),
         Species = gsub(' ST.*','',st1),
         ST = gsub('.* ','',ST)) %>% 
  left_join(facil_st_orig %>% select(Sample_ID, Cult_Date, cult_year) %>% 
              rename(isolate1 = Sample_ID, date1 = Cult_Date, year1 = cult_year)) %>% 
  left_join(facil_st_orig %>% select(Sample_ID, Cult_Date, cult_year) %>% 
              rename(isolate2 = Sample_ID, date2 = Cult_Date, year2 = cult_year)) %>% 
  mutate(datediff = abs(ymd(date1) - ymd(date2)))

mn_snv_dat <- mn_snv_dat_orig %>% 
  filter(ST %in% c('ST258', 'ST171') & year1 == year2)
```

```{r}
fs4b <- mn_snv_dat %>% 
  filter(pair_type != 'Unknown') %>% 
  mutate(pair_type = gsub(' pair', '', pair_type),
         ST = ifelse(ST == 'ST171', 'KPC-Eh ST171', 'KPC-Kp ST258')) %>% 
  ggplot(aes(x = year1, y = pairwise_dist, col = under_thresh, shape = pair_type)) +
  facet_grid(~ST) +
  geom_jitter(alpha = 0.7) +
  scale_color_manual(values = c('[0,5]' = "#9EBCDA",'(5,10]' = "#BFD3E6", '(10,15]' = "#E0ECF4",'(15,∞)' = "#FBB4AE")) +
  scale_shape_manual(values = c(1, 19)) +
  labs(x = 'Year', y = 'Pairwise SNV distance', col = 'SNV bin', shape = 'Isolate\npair type')
```

```{r, fig.width=7, fig.height=7}
fs4 <- plot_grid(fs4a, fs4b, ncol = 1, labels = 'AUTO')
ggsave(plot = fs4, filename = 'figures/FigS4.png', width = 7, height = 7)
fs4
```



## MN ST171 transmission (Figure 3)

```{r}
f3a <- mn_snv_dat_orig %>% 
  filter(ST %in% c('ST258', 'ST171') & pair_type != 'Unknown') %>% 
  mutate(datediff_bin = cut(as.numeric(datediff), breaks = c(-1, 365*1:7),
                            labels = c('0-1', paste0(1:6, '-', 2:7))),
         under_thresh = factor(under_thresh, 
                               levels = rev(unique(levels(under_thresh)))),
         st1 = gsub('E. hormaechei', 'KPC-Eh', st1),
         st1 = gsub('K. pneumoniae', 'KPC-Kp', st1)) %>% 
  ggplot(aes(x = datediff_bin, fill = under_thresh)) +
  facet_grid(pair_type~st1, scales = 'free') + 
  geom_bar() +
  scale_fill_manual(values = c('[0,5]' = "#9EBCDA",'(5,10]' = "#BFD3E6", '(10,15]' = "#E0ECF4",'(15,∞)' = "#FBB4AE")) +
  labs(x = 'Number of years separating isolates', y = 'Number of isolate pairs',
       fill = 'SNV bin')
```

```{r}
f3b <- mn_snv_dat_orig %>% 
  filter(ST %in% c('ST171') & loc1 == loc2 & pairwise_dist <= 15) %>% 
  mutate(datediff_bin = cut(as.numeric(datediff), breaks = c(-1, 365*1:7),
                            labels = c('0-1', paste0(1:6, '-', 2:7))),
         under_thresh = factor(under_thresh,
                               levels = rev(unique(levels(under_thresh))))
         ) %>% 
  group_by(loc1, ST, under_thresh, datediff_bin) %>% 
  summarize(count = n()) %>%
  mutate(f38 = ifelse(count > 50, loc1, NA),
         ST = paste0('KPC-Eh ', ST)) %>%
  ggplot(aes(x = loc1, y = count, fill = under_thresh)) +
  facet_grid(~ST) +
  geom_col() +
  scale_y_continuous(breaks = pretty_breaks())  +
  scale_fill_manual(values = c('[0,5]' = "#9EBCDA",'(5,10]' = "#BFD3E6", '(10,15]' = "#E0ECF4",'(15,∞)' = "#FBB4AE")) +
  labs(y = 'Number of pairs', x = 'Facility of intra-facility pair', fill = 'SNV bin')
```

```{r}
f3c <- mn_snv_dat_orig %>% 
  filter(ST %in% c('ST171') & pairwise_dist <= 15 & loc1 != loc2) %>% 
  mutate(datediff_bin = cut(as.numeric(datediff), breaks = c(-1, 365*1:7),
                            labels = c('0-1', paste0(1:6, '-', 2:7))),
         under_thresh = factor(under_thresh, 
                               levels = rev(unique(levels(under_thresh))))) %>% 
  pivot_longer(c(loc1, loc2)) %>% 
  group_by(value, ST, under_thresh) %>% 
  summarize(count = n()) %>%
  mutate(f38 = ifelse(count > 50, value, NA),
         ST = paste0('KPC-Eh ', ST)) %>% 
  ggplot(aes(x = value, y = count, fill = under_thresh)) +
  facet_grid(~ST, scales = 'free') +
  # geom_histogram(binwidth = 5) +
  geom_col() +
  # geom_text(aes(y = 1.5, label = f38)) +
  scale_y_continuous(breaks = pretty_breaks())  +
  scale_fill_manual(values = c('[0,5]' = "#9EBCDA",'(5,10]' = "#BFD3E6", '(10,15]' = "#E0ECF4",'(15,∞)' = "#FBB4AE")) +
  labs(y = 'Number of isolates', x = 'Facility of inter-facility pair', fill = 'SNV bin')
```

```{r}
mn_snv_dat_orig %>% 
  filter(ST %in% c('ST171') & pairwise_dist <= 10 &
           !is.na(loc1) & !is.na(loc2) & loc1 != loc2) %>% 
  mutate(datediff_bin = cut(as.numeric(datediff), breaks = c(-1, 365*1:7),
                            labels = c('0-1 year', paste0(1:6, '-', 2:7, ' years'))),
         under_thresh = factor(under_thresh, 
                               levels = rev(unique(levels(under_thresh)))),
         loc1 = ifelse(loc1 %in% c('F38'), loc1, 'Other'),
         loc2 = ifelse(loc2 %in% c('F38'), loc2, 'Other')
         # loc1 = ifelse(loc1 %in% c('F38', 'F55', 'F34', 'F46'), loc1, 'Other'),
         # loc2 = ifelse(loc2 %in% c('F38', 'F55', 'F34', 'F46'), loc2, 'Other')
         ) %>% 
  rowwise() %>% 
  mutate(loc1_new = paste(sort(c(loc1, loc2)))[1],
         loc2_new = paste(sort(c(loc1, loc2)))[2]) %>% 
  ungroup() %>%
  mutate(f38 = loc1_new == 'F38' | loc2_new == 'F38') %>% 
  group_by(f38) %>% 
  summarize(count = n()) %>% 
  ungroup() %>% 
  mutate(tot = sum(count),
         pct = paste0(round(count/tot*100), '%')) 
```

```{r}
mn_snv_dat_orig %>% 
  filter(ST %in% c('ST171') & pairwise_dist <= 10 &
           !is.na(loc1) & !is.na(loc2) & loc1 == loc2) %>% 
  mutate(f38 = loc1 == 'F38' | loc2 == 'F38') %>% 
  group_by(f38) %>% 
  summarize(count = n()) %>% 
  ungroup() %>% 
  mutate(tot = sum(count),
         pct = paste0(round(count/tot*100), '%')) 
```

```{r}
f3d <- mn_snv_dat_orig %>% 
  filter(ST %in% c('ST171') & pairwise_dist <= 10 &
           !is.na(loc1) & !is.na(loc2) & loc1 != loc2) %>% 
  mutate(datediff_bin = cut(as.numeric(datediff), breaks = c(-1, 365*1:7),
                            labels = c('0-1 year', paste0(1:6, '-', 2:7, ' years'))),
         under_thresh = factor(under_thresh, 
                               levels = rev(unique(levels(under_thresh)))),
         loc1 = ifelse(loc1 %in% c('F38', 'F55', 'F34', 'F46'), loc1, 'Other'),
         loc2 = ifelse(loc2 %in% c('F38', 'F55', 'F34', 'F46'), loc2, 'Other')
         ) %>% 
  rowwise() %>% 
  mutate(loc1_new = paste(sort(c(loc1, loc2)))[1],
         loc2_new = paste(sort(c(loc1, loc2)))[2]) %>% 
  ungroup() %>%
  group_by(loc1_new, loc2_new) %>% 
  summarize(count = n()) %>% 
  ungroup() %>% 
  mutate(tot = sum(count),
         pct = paste0(round(count/tot*100), '%')) %>% 
  ggplot(aes(x = loc1_new, y = loc2_new, fill = count, label = pct)) + 
  geom_tile() +
  geom_text(col = 'white') +
  labs(x = 'Location of isolate 1', y = 'Location of isolate 2', 
       fill = 'Number of pairs\nwithin 10 SNVs')
```

```{r}
g_mn <- mn_trans_net_sub %>% 
  select(source_facil, dest_facil) %>%
  as.matrix() %>% 
  graph_from_edgelist(directed = TRUE)

E(g_mn)$weight = mn_trans_net_sub %>% select(n_transfers) %>% deframe()

deg <- igraph::degree(g_mn)
stre <- strength(g_mn)
betw <- betweenness(g_mn)
clos <- closeness(g_mn, mode = 'all')

facil_w_ind <- which(names(V(g_mn)) == 'F38') # F55

f3e <- bind_cols(inds=names(deg), 'Degree'=deg, 'Strength'=stre, 'Betweenness'=betw, 'Closeness'=clos) %>% 
  pivot_longer(cols = -inds) %>% 
  filter(name == 'Degree') %>% 
  ggplot(aes(x = value)) + geom_histogram(bins = 70) +
  geom_point(data = data.frame(
    value=c(deg[facil_w_ind], stre[facil_w_ind], betw[facil_w_ind],clos[facil_w_ind]),
    name=c('Degree','Strength','Betweenness','Closeness')) %>% 
      filter(name == 'Degree'),
    aes(x = value, y = 0), col = 'red', shape = 18, size = 3) +
  ggrepel::geom_text_repel(data = data.frame(
    value=c(deg[facil_w_ind], stre[facil_w_ind], betw[facil_w_ind],clos[facil_w_ind]), 
    name=c('Degree','Strength','Betweenness','Closeness')) %>% 
      filter(name == 'Degree'), 
    aes(label = 'F38', y = 0), col = 'red', size = 3) +
  labs(x = 'Degree centrality', y = 'Number of facilities') +
  # facet_wrap(~name, scales = 'free') +
  theme(plot.margin = margin(0,0.5,0,0, "cm"))
```

```{r}
mn_pt_trans_all <- get_patient_flow(mn_trans_net_sub,
                                    unique(facil_st_orig$Facility_ID)[unique(facil_st_orig$Facility_ID) %in% 
                                                        c(mn_trans_net_sub$source_facil,
                                                          mn_trans_net_sub$dest_facil)]) %>% 
  filter(!duplicated(.))
```

```{r}
f3f <- mn_pt_trans_all %>% 
  mutate(of_interest = loc1 == 'F38' & loc2 %in% c('F55', 'F46', 'F34') |
           loc2 == 'F38' & loc1 %in% c('F55', 'F46', 'F34')) %>% 
  ggplot(aes(x = sum_transfers)) +
  geom_histogram(bins = 100) +
  geom_point(data = mn_pt_trans_all %>% 
               filter(loc1 == 'F38' & loc2 %in% c('F55', 'F46', 'F34') |
                        loc2 == 'F38' & loc1 %in% c('F55', 'F46', 'F34')) %>% 
               mutate(loc = ifelse(loc1 == 'F38', paste0('F38-', loc2), 
                                   paste0('F38-', loc1))),
             aes(y = 0), col = 'red') +
  geom_label_repel(data = mn_pt_trans_all %>% 
               filter(loc1 == 'F38' & loc2 %in% c('F55', 'F46', 'F34') |
                        loc2 == 'F38' & loc1 %in% c('F55', 'F46', 'F34')) %>% 
               mutate(loc = ifelse(loc1 == 'F38', paste0('F38-', loc2), 
                                   paste0('F38-', loc1))),
             aes(y = 0, label = loc), col = 'red', 
             box.padding = 0.5, max.overlaps = Inf) +
  labs(y = 'Number of facilities', x = 'Number of patient transfers between F38 and another facility')
  
```

```{r, fig.width=15, fig.height=7}
f3 <- plot_grid(f3a + theme(legend.position = 'left'), 
          f3b + theme(legend.position = 'none'), 
          f3c + theme(legend.position = 'none',
                      axis.text.x = element_text(size = 5)), 
          f3d + facet_grid(''~.) + theme(legend.position = 'left'),
          f3e, 
          f3f, 
          labels = 'AUTO', rel_widths = c(1, 0.8, 1))

ggsave(plot = f3, filename = 'figures/Fig3.png', width = 15, height = 7)
f3
```


```{r}
mn_pt_trans_all %>%
  mutate(n_transfers_f12 = ifelse(is.na(n_transfers_f12), 0, n_transfers_f12),
         n_transfers_f21 = ifelse(is.na(n_transfers_f21), 0, n_transfers_f21),
         sum_transfers = n_transfers_f12 + n_transfers_f21) %>% 
  arrange(sum_transfers) %>% 
  mutate(rank = row_number(), 
         tot = nrow(.),
         percentile = rank/tot) %>% 
  filter(loc1 == 'F38' & loc2 %in% c('F55', 'F46', 'F34') |
           loc2 == 'F38' & loc1 %in% c('F55', 'F46', 'F34')) %>% 
  select(loc1, loc2, rank, tot, percentile)
```


## TN facility cluster (Figure 4)

```{r, results='hide'}
prior_hosps_tn_counts <- prior_hosps_tn %>% 
  select(Sample_ID, Fac_ID) %>% 
  unique() %>% 
  rename(Facility = Fac_ID) %>% 
  bind_rows(prior_hosps_tn %>% 
              select(Sample_ID, Prior_facil) %>% 
              rename(Facility = Prior_facil)) %>% 
  left_join(facil_st %>% 
              mutate(ST = ifelse(ST %in% c('E. hormaechei ST171','E. hormaechei ST114',
                                 'K. pneumoniae ST258','K. pneumoniae ST307', 
                                 'E. cloacae ST171', 'E. cloacae ST114', 
                                 'ST258', 'ST307', 'ST114', 'ST171'),
                       ST, 'Other'))) %>% 
  filter(!is.na(ST)) %>% 
  group_by(ST, Facility) %>% 
  summarize(count = n()) %>% 
  arrange(-count) 

tn_hm <- prior_hosps_tn_counts %>% 
  pivot_wider(names_from = Facility, values_from = count, values_fill = 0) %>% 
  data.frame(row.names = .$ST) %>% 
  select(-ST) %>% 
  pheatmap(show_colnames = FALSE, fontsize_col = 8)

tn_facil_hm <- prior_hosps_tn_counts %>% 
  mutate(Facility = factor(Facility, levels = rev(tn_hm$tree_col$labels[tn_hm$tree_col$order]) %>% gsub('TDH.', 'TDH-', .) %>% gsub('LONG.', 'LONG-', .) %>% gsub('VA.', 'VA-', .) %>% gsub('\\.', ' ', .)),
         ST = factor(ST, levels = tn_hm$tree_row$labels),
         ST = gsub('E. hormaechei', 'KPC-Eh', ST),
         ST = gsub('K. pneumoniae', 'KPC-Kp', ST),
         ST = factor(ST, levels = rev(c('KPC-Kp ST258', 'KPC-Eh ST171', 'Other', 'KPC-Eh ST114', 'KPC-Kp ST307'))),
) %>% 
  ggplot(aes(x = Facility, y = ST, fill = count)) +
  geom_tile() +
  geom_rect(aes(xmin = 0+0.5, xmax = 7+0.5, ymin = 0+0.5, ymax = 3+0.5), fill = NA, col = 'black', size = 1, linetype = 'dotted') +
  scale_fill_viridis_c(direction = -1, breaks = scales::pretty_breaks(), option = 'magma') +
  theme_classic() +
  theme(axis.text.x = element_blank(), axis.text.y = element_markdown()) +
  labs(fill = 'Count')
```

```{r}
tn_facils_st <- facil_st %>% filter(State == 'TN') %>% 
  mutate(ST = ifelse(ST %in% c('E. hormaechei ST171','E. hormaechei ST114',
                                 'K. pneumoniae ST258','K. pneumoniae ST307', 
                                 'E. cloacae ST171', 'E. cloacae ST114', 
                                 'ST258', 'ST307', 'ST114', 'ST171'),
                       ST, 'Other')) %>% 
  filter(!is.na(Facility_ID)) %>% 
  group_by(Facility_ID, ST) %>% 
  summarize(count = n()) %>% 
  arrange(Facility_ID) %>% 
  group_by(Facility_ID) %>% 
  mutate(max_count = count[which.max(count)],
         n_isolates = sum(count)) %>% 
  group_by(Facility_ID, n_isolates) %>% 
  summarize(max_sts = str_c(ST[count == max_count], collapse = ', ')) %>% 
  left_join(tn_facil_cluster) %>% 
  mutate(facil_st_type = case_when(max_sts == 'K. pneumoniae ST258' ~ 'K. pneumoniae ST258',
                                   grepl('K. pneumoniae ST258', max_sts) & max_sts != 'K. pneumoniae ST258' ~ 'K. pneumoniae ST258 & Other',
                                   of_interest ~ 'ST307/ST114/Other facility cluster'),
         facil_st_type = ifelse(is.na(facil_st_type), 'Other', facil_st_type)) 
```

```{r}
graph_tn <- tbl_graph(nodes = tn_facils_st %>% 
                        mutate(facil_st_type = gsub('K. pneumoniae', 'KPC-Kp', facil_st_type),
                               facil_st_type = gsub('E. hormaechei', 'KPC-Eh', facil_st_type),
                               facil_st_type = gsub(' facility cluster', 
                                                    '\nfacility cluster', facil_st_type)
                               ), 
                      edges = tn_trans_net_sub %>% 
                        filter(!grepl('I', source_facil) & !grepl('I', dest_facil) & n_transfers > 1),
                      directed = TRUE) %>%
  induced.subgraph(igraph::degree(.) > 0)

tn_network <- graph_tn %>% 
  ggraph(layout = 'kk') + 
  geom_edge_link(aes(color = n_transfers, alpha = n_transfers), arrow = arrow(length = unit(3, 'mm'))) + 
  geom_node_point(aes(color = facil_st_type, size = n_isolates)) + 
  # scale_edge_color_viridis(direction = -1, option = 'E') +
  scale_edge_color_continuous(high = '#00204c', low = '#ffe945') +
  scale_color_manual(values = c(unname(st_cols[1]), 'coral3', 'lightsalmon', 'grey')) +
  guides(edge_alpha = 'none') +
  theme_graph() +
  labs(color = 'Most common ST', shape = '', size = 'Number of isolates',
       edge_color = 'Number of transfers\n(in thousands)')
```

```{r}
tn_facil_transfers <- tn_trans_net_sub %>% 
  left_join(tn_facils_st %>% rename(source_of_interest = of_interest) %>% 
              select(Facility_ID, source_of_interest), 
            by = c(source_facil = 'Facility_ID')) %>% 
  left_join(tn_facils_st %>% rename(dest_of_interest = of_interest) %>% 
              select(Facility_ID, dest_of_interest), 
            by = c(dest_facil = 'Facility_ID')) %>% 
  replace(is.na(.), 0) %>% 
  mutate(of_interest = source_of_interest + dest_of_interest) %>% 
  filter(!grepl('I', source_facil) & !grepl('I', dest_facil) & n_transfers > 1) %>%
  ggplot(aes(x = n_transfers, linetype = factor(of_interest, levels = c(2, 1, 0)))) +
  geom_density() +
  labs(x = 'Number of patient transfers', y = 'Density', linetype = 'Number of isolates\nof pair in facility\ncluster') +
  theme(legend.position = 'left')
```

```{r}
tn_trans_net_sub %>% 
  left_join(tn_facils_st %>% rename(source_of_interest = of_interest) %>% 
              select(Facility_ID, source_of_interest), 
            by = c(source_facil = 'Facility_ID')) %>% 
  left_join(tn_facils_st %>% rename(dest_of_interest = of_interest) %>% 
              select(Facility_ID, dest_of_interest), 
            by = c(dest_facil = 'Facility_ID')) %>% 
  replace(is.na(.), 0) %>% 
  mutate(of_interest = source_of_interest + dest_of_interest) %>% 
  filter(!grepl('I', source_facil) & !grepl('I', dest_facil) & n_transfers > 1) %>% 
  filter(source_of_interest | dest_of_interest) %>% 
  ungroup() %>% 
  summarize(wilcox_p = wilcox.test(n_transfers[of_interest == 1], n_transfers[of_interest == 2])$p.value)
```


```{r, fig.width=12, fig.height=5}
f4 <- plot_grid(plot_grid(tn_facil_hm + theme(legend.position = 'left'), tn_facil_transfers, nrow = 2, align = 'hv', labels = c('A', 'C')), tn_network, nrow = 1, rel_widths = c(0.8, 1), labels = c('', 'B')) 

ggsave(filename = 'figures/Fig4.png', plot = f4, width = 12, height = 5)
f4
```

## Supplemental file with isolate IDs and information

```{r}
sample_metadat <- read_csv('data/eip-metadat-short.csv') %>% 
  rename(Pat_ID = Patient_ID) %>% 
  mutate(Species = gsub('cloacae', 'hormaechei', Species),
         ST = gsub('cloacae', 'hormaechei', ST)) %>% 
  left_join(facil_st) %>% 
  select(-c(latitude, longitude))

all_sample_info <- sample_metadat %>% 
  select(Fac_ID, Facility_ID) %>% 
  filter(!is.na(Facility_ID)) %>% 
  unique() %>% 
  right_join(sample_metadat %>% select(-Facility_ID)) %>% 
  select(-Patient_ID) %>% 
  left_join(sample_metadat %>% 
              select(Pat_ID, Patient_ID) %>% 
              filter(!is.na(Patient_ID)) %>% 
              unique()) %>% 
  mutate(Cult_Year = gsub('-.*', '', Cult_Date)) 

all_sample_info_not_tn <- all_sample_info %>% 
  filter(State != 'TN') %>% 
  arrange(Patient_ID) %>% 
  mutate(Pat_ID = factor(Pat_ID, levels = unique(Pat_ID)),
         Patient_ID = ifelse(is.na(Patient_ID), paste0('P', as.numeric(factor(Pat_ID))), Patient_ID),
         Patient_ID = ifelse(Patient_ID == 'PNA', NA, Patient_ID)) %>% 
  select(Sample_ID, Patient_ID, Facility_ID, Cult_Year, State, Species, ST) %>% 
  arrange(Sample_ID) 

all_sample_info_not_tn %>% 
  write_csv('data/supp_file_1.csv')

# to not submit to ncbi (because previously submitted)
dont_submit <- all_sample_info_not_tn %>% 
  filter(State == 'MN' & Species == 'E. hormaechei' & Cult_Year < 2013) %>% 
  pull(Sample_ID) 

dont_submit %>% 
  cat(sep = ',')
```

```{r}
all_sample_info %>% 
  select(Sample_ID, State, Species, ST) %>% 
  left_join(all_sample_info_not_tn) %>% 
  filter(!Sample_ID %in% dont_submit) %>% 
  rename(sample_name = Sample_ID,
         organism = Species,
         collection_date = Cult_Year) %>% 
  mutate(bioproject_accession = 'PRJNA873034',
         isolate = paste0(sample_name, '_', Patient_ID, '_', Facility_ID),
         strain = ifelse(grepl('ST', ST), gsub('.*ST', 'ST', ST), NA),
         collected_by = case_when(State == 'MN' ~ 'Minnesota Department of Health',
                                  State == 'TN' ~ 'Tennessee Department of Health',
                                  State == 'CT' ~ 'Connecticut Department of Public Health'),
         geo_loc_name = paste0('USA: ', State),
         host = 'Homo sapiens',
         host_disease = 'not applicable', 
         isolation_source = 'not collected',
         lat_lon = 'not collected') %>% 
  select(sample_name,	bioproject_accession,	organism,	strain,	isolate,	collected_by,	collection_date,
         geo_loc_name,	host,	host_disease,	isolation_source,	lat_lon) %>% 
  write_csv('data/sra_submission_info.csv')
```


